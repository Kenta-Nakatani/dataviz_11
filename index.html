<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœ¬ã®GDPæˆé•· - å›½åœŸé¢ç©ã§è¦‹ã‚‹æˆé•·</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 100%;
            margin: 0;
            background: white;
            border-radius: 0;
            padding: 15px 20px 20px;
            box-shadow: none;
            min-height: 100vh;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 8px;
            font-size: 24px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 12px;
        }
        .controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .year-display {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            min-width: 80px;
            text-align: center;
        }
        input[type="range"] {
            width: 300px;
            height: 6px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            min-width: 150px;
            text-align: center;
        }
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 22px;
            font-weight: bold;
        }
        #map {
            width: 100%;
            height: calc(100vh - 350px);
            min-height: 500px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: #f5f5f5;
        }
        .prefecture {
            stroke: #fff;
            stroke-width: 0.5;
            cursor: pointer;
            transition: opacity 0.3s;
        }
        .prefecture:hover {
            opacity: 0.8;
        }
        .prefecture.highlighted {
            stroke: #333;
            stroke-width: 2;
        }
        .main-content {
            display: flex;
            gap: 24px;
            align-items: stretch;
            margin-top: 10px;
        }
        .explanation {
            flex: 0 0 340px;
            max-width: 380px;
            font-size: 14px;
            line-height: 1.8;
            color: #444;
        }
        .explanation-title {
            font-weight: bold;
            font-size: 15px;
            margin-bottom: 6px;
            color: #333;
        }
        .explanation-point {
            margin-bottom: 6px;
        }
        .legend {
            margin-top: 15px;
            text-align: center;
        }
        .legend-item {
            display: inline-block;
            margin: 0 12px;
            font-size: 12px;
        }
        .legend-color {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 5px;
            vertical-align: middle;
        }
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            pointer-events: none;
            font-size: 12px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ‡¯ğŸ‡µ æ—¥æœ¬ã®GDPæˆé•· - å›½åœŸé¢ç©ã§è¦‹ã‚‹æˆé•·</h1>
        <p class="subtitle">ç¾åœ¨ã®GDPï¼ˆ2024å¹´ï¼‰ã‚’100%ã¨ã—ã¦ã€éå»ã®GDPãŒå›½åœŸã®ä½•%ã«ç›¸å½“ã™ã‚‹ã‹ã‚’è¦–è¦šåŒ–</p>
        
        <div class="controls">
            <button id="playBtn" style="padding: 8px 16px; font-size: 14px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">â–¶ å†ç”Ÿ</button>
            <input type="range" id="yearSlider" min="0" max="64" value="64" step="1">
            <div class="year-display" id="yearDisplay">2024</div>
        </div>
        
        <div class="stats">
            <div class="stat-box">
                <div class="stat-label">é¸æŠå¹´ã®GDP</div>
                <div class="stat-value" id="currentGDP">$4.03å…†</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">ç¾åœ¨ã®GDPã«å¯¾ã™ã‚‹å‰²åˆ</div>
                <div class="stat-value" id="gdpRatio">100.0%</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">å›½åœŸé¢ç©ã«æ›ç®—</div>
                <div class="stat-value" id="areaRatio">100.0%</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">æ—¥æœ¬åˆ—å³¶æ›ç®—</div>
                <div class="stat-value" id="japanCount">1.00å€‹</div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="explanation">
                <div class="explanation-title">ã“ã®å›³ã®æ„å›³</div>
                <div class="explanation-point">
                    ãƒ»<strong>ä»Šã®æ—¥æœ¬ã®GDPï¼ˆ2024å¹´ï¼‰ã‚’ã€Œæ—¥æœ¬åˆ—å³¶1å€‹ã¶ã‚“ã€</strong>ã¨ã—ã¦å›ºå®šã—ã€<br>
                    ã€€éå»ã®GDPãŒãã®ä½•å€‹åˆ†ãƒ»ä½•ï¼…åˆ†ã«ã‚ãŸã‚‹ã‹ã‚’ã€<strong>å›½åœŸã®é¢ç©</strong>ã§è¡¨ç¾ã—ã¦ã„ã¾ã™ã€‚
                </div>
                <div class="explanation-point">
                    ãƒ»ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§å¹´ã‚’å‹•ã‹ã™ã¨ã€<strong>ç·‘ã®é¢ç©</strong>ãŒå¢—æ¸›ã—ã€<br>
                    ã€€ã€Œã“ã®å¹´ã®æ—¥æœ¬ã¯ã€ä»Šã¨æ¯”ã¹ã¦å›½åœŸä½•çœŒã¶ã‚“æˆé•·ï¼ç¸®å°ã—ãŸã‹ã€ã¨ã„ã†æ„Ÿè¦šã§è¦‹ã‚‰ã‚Œã¾ã™ã€‚
                </div>
                <div class="explanation-point">
                    ãƒ»å·¦ã‹ã‚‰å³ã«ã€æ—¥æœ¬åˆ—å³¶ãŒ<strong>1å€‹ã€2å€‹ã€3å€‹â€¦</strong>ã¨ä¸¦ã¶ã“ã¨ã§ã€<br>
                    ã€€ã€Œé«˜åº¦æˆé•·æœŸã«ã¯ã€æ—¥æœ¬ãŒä¸¸ã”ã¨ä½•å€‹åˆ†ã«ã‚‚è†¨ã‚‰ã‚“ã ã€<br>
                    ã€€ã¨ã„ã†ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ç›´æ„Ÿçš„ã«æ´ã‚ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
                </div>
                <div class="explanation-point">
                    ãƒ»éƒ½é“åºœçœŒã¯<strong>é¢ç©ãŒè¿‘ã„çœŒã©ã†ã—ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–</strong>ã—ã¦å¡—ã‚Šåˆ†ã‘ã¦ãŠã‚Šã€<br>
                    ã€€åŒ—æµ·é“ã ã‘ãŒæ¥µç«¯ã«å¤§ããè¦‹ãˆã™ããªã„ã‚ˆã†ã«å·¥å¤«ã—ã¦ã„ã¾ã™ã€‚
                </div>
            </div>
            <div style="flex: 1; min-width: 0;">
                <div id="map"></div>
                
                <div class="legend">
                    <div class="legend-item">
                        <span class="legend-color" style="background: #4CAF50;"></span>
                        è©²å½“å¹´ã®GDPã«ç›¸å½“ã™ã‚‹éƒ½é“åºœçœŒ
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background: #E0E0E0;"></span>
                        è©²å½“å¹´ã®GDPã«ç›¸å½“ã—ãªã„éƒ½é“åºœçœŒ
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip" style="display: none;"></div>
    
    <script>
        // GDPãƒ‡ãƒ¼ã‚¿ï¼ˆ1960-2024ï¼‰- CSVã‹ã‚‰æŠ½å‡º
        const gdpData = [
            47419238274, 57266758180, 64987857542, 74379284603, 87490590818, 97338107606,
            113047000000, 132476000000, 156897000000, 184299000000, 217224000000, 245364000000,
            324934000000, 441461000000, 490036000000, 532861000000, 598884000000, 737069000000,
            1035610000000, 1077910000000, 1129380000000, 1245220000000, 1158730000000, 1270860000000,
            1345820000000, 1427020000000, 2120080000000, 2580750000000, 3125720000000, 3109460000000,
            3185900000000, 3648070000000, 3980700000000, 4536940000000, 4998800000000, 5545560000000,
            4923390000000, 4492450000000, 4098360000000, 4635980000000, 4968360000000, 4374710000000,
            4182850000000, 4519560000000, 4893120000000, 4831470000000, 4601660000000, 4579750000000,
            5106680000000, 5289490000000, 5759070000000, 6233150000000, 6272360000000, 5212330000000,
            4896990000000, 4444930000000, 5003680000000, 4930840000000, 5040880000000, 5117990000000,
            5054070000000, 5039150000000, 4262460000000, 4213170000000, 4026210000000
        ];
        
        const years = Array.from({length: 65}, (_, i) => 1960 + i);
        const currentGDP = gdpData[gdpData.length - 1]; // 2024å¹´ã®GDP
        
        // éƒ½é“åºœçœŒã®é¢ç©ãƒ‡ãƒ¼ã‚¿ï¼ˆkmÂ²ï¼‰- å¤§ãã„é †
        const prefectureAreas = [
            {name: "Hokkaido", area: 83424, jpName: "åŒ—æµ·é“"},
            {name: "Iwate", area: 15275, jpName: "å²©æ‰‹çœŒ"},
            {name: "Fukushima", area: 13784, jpName: "ç¦å³¶çœŒ"},
            {name: "Nagano", area: 13562, jpName: "é•·é‡çœŒ"},
            {name: "Niigata", area: 12584, jpName: "æ–°æ½ŸçœŒ"},
            {name: "Akita", area: 11637, jpName: "ç§‹ç”°çœŒ"},
            {name: "Gifu", area: 10621, jpName: "å²é˜œçœŒ"},
            {name: "Aomori", area: 9646, jpName: "é’æ£®çœŒ"},
            {name: "Yamagata", area: 9323, jpName: "å±±å½¢çœŒ"},
            {name: "Kochi", area: 7104, jpName: "é«˜çŸ¥çœŒ"},
            {name: "Kumamoto", area: 7409, jpName: "ç†Šæœ¬çœŒ"},
            {name: "Kagoshima", area: 9187, jpName: "é¹¿å…å³¶çœŒ"},
            {name: "Miyazaki", area: 7735, jpName: "å®®å´çœŒ"},
            {name: "Oita", area: 6341, jpName: "å¤§åˆ†çœŒ"},
            {name: "Shimane", area: 6708, jpName: "å³¶æ ¹çœŒ"},
            {name: "Miyagi", area: 7282, jpName: "å®®åŸçœŒ"},
            {name: "Okayama", area: 7113, jpName: "å²¡å±±çœŒ"},
            {name: "Hiroshima", area: 8479, jpName: "åºƒå³¶çœŒ"},
            {name: "Yamaguchi", area: 6112, jpName: "å±±å£çœŒ"},
            {name: "Tochigi", area: 6408, jpName: "æ ƒæœ¨çœŒ"},
            {name: "Gunma", area: 6362, jpName: "ç¾¤é¦¬çœŒ"},
            {name: "Ibaraki", area: 6097, jpName: "èŒ¨åŸçœŒ"},
            {name: "Shizuoka", area: 7777, jpName: "é™å²¡çœŒ"},
            {name: "Aichi", area: 5173, jpName: "æ„›çŸ¥çœŒ"},
            {name: "Mie", area: 5774, jpName: "ä¸‰é‡çœŒ"},
            {name: "Wakayama", area: 4726, jpName: "å’Œæ­Œå±±çœŒ"},
            {name: "Nara", area: 3691, jpName: "å¥ˆè‰¯çœŒ"},
            {name: "Hyogo", area: 8401, jpName: "å…µåº«çœŒ"},
            {name: "Kyoto", area: 4612, jpName: "äº¬éƒ½åºœ"},
            {name: "Osaka", area: 1905, jpName: "å¤§é˜ªåºœ"},
            {name: "Shiga", area: 4017, jpName: "æ»‹è³€çœŒ"},
            {name: "Fukui", area: 4190, jpName: "ç¦äº•çœŒ"},
            {name: "Ishikawa", area: 4186, jpName: "çŸ³å·çœŒ"},
            {name: "Toyama", area: 4247, jpName: "å¯Œå±±çœŒ"},
            {name: "Yamanashi", area: 4465, jpName: "å±±æ¢¨çœŒ"},
            {name: "Kanagawa", area: 2416, jpName: "ç¥å¥ˆå·çœŒ"},
            {name: "Tokyo", area: 2194, jpName: "æ±äº¬éƒ½"},
            {name: "Chiba", area: 5157, jpName: "åƒè‘‰çœŒ"},
            {name: "Saitama", area: 3798, jpName: "åŸ¼ç‰çœŒ"},
            {name: "Fukuoka", area: 4986, jpName: "ç¦å²¡çœŒ"},
            {name: "Saga", area: 2440, jpName: "ä½è³€çœŒ"},
            {name: "Nagasaki", area: 4131, jpName: "é•·å´çœŒ"},
            {name: "Okinawa", area: 2281, jpName: "æ²–ç¸„çœŒ"},
            {name: "Ehime", area: 5676, jpName: "æ„›åª›çœŒ"},
            {name: "Tokushima", area: 4147, jpName: "å¾³å³¶çœŒ"},
            {name: "Kagawa", area: 1877, jpName: "é¦™å·çœŒ"},
            {name: "Tottori", area: 3507, jpName: "é³¥å–çœŒ"}
        ];
        
        const totalArea = prefectureAreas.reduce((sum, p) => sum + p.area, 0);
        
        // éƒ½é“åºœçœŒåã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆGeoJSONã®NAME_1ã¨æ—¥æœ¬èªåã®å¯¾å¿œï¼‰
        const prefectureNameMap = {
            "Aichi": "æ„›çŸ¥çœŒ", "Akita": "ç§‹ç”°çœŒ", "Aomori": "é’æ£®çœŒ", "Chiba": "åƒè‘‰çœŒ",
            "Ehime": "æ„›åª›çœŒ", "Fukui": "ç¦äº•çœŒ", "Fukuoka": "ç¦å²¡çœŒ", "Fukushima": "ç¦å³¶çœŒ",
            "Gifu": "å²é˜œçœŒ", "Gunma": "ç¾¤é¦¬çœŒ", "Hiroshima": "åºƒå³¶çœŒ", "Hokkaido": "åŒ—æµ·é“",
            "Hyogo": "å…µåº«çœŒ", "Ibaraki": "èŒ¨åŸçœŒ", "Ishikawa": "çŸ³å·çœŒ", "Iwate": "å²©æ‰‹çœŒ",
            "Kagawa": "é¦™å·çœŒ", "Kagoshima": "é¹¿å…å³¶çœŒ", "Kanagawa": "ç¥å¥ˆå·çœŒ", "Kochi": "é«˜çŸ¥çœŒ",
            "Kumamoto": "ç†Šæœ¬çœŒ", "Kyoto": "äº¬éƒ½åºœ", "Mie": "ä¸‰é‡çœŒ", "Miyagi": "å®®åŸçœŒ",
            "Miyazaki": "å®®å´çœŒ", "Nagano": "é•·é‡çœŒ", "Nagasaki": "é•·å´çœŒ", "Nara": "å¥ˆè‰¯çœŒ",
            "Niigata": "æ–°æ½ŸçœŒ", "Oita": "å¤§åˆ†çœŒ", "Okayama": "å²¡å±±çœŒ", "Okinawa": "æ²–ç¸„çœŒ",
            "Osaka": "å¤§é˜ªåºœ", "Saga": "ä½è³€çœŒ", "Saitama": "åŸ¼ç‰çœŒ", "Shiga": "æ»‹è³€çœŒ",
            "Shimane": "å³¶æ ¹çœŒ", "Shizuoka": "é™å²¡çœŒ", "Tochigi": "æ ƒæœ¨çœŒ", "Tokushima": "å¾³å³¶çœŒ",
            "Tokyo": "æ±äº¬éƒ½", "Tottori": "é³¥å–çœŒ", "Toyama": "å¯Œå±±çœŒ", "Wakayama": "å’Œæ­Œå±±çœŒ",
            "Yamagata": "å±±å½¢çœŒ", "Yamaguchi": "å±±å£çœŒ", "Yamanashi": "å±±æ¢¨çœŒ"
        };
        
        let geoData = null;
        let currentYearIndex = 64;
        let isPlaying = false;
        let playInterval = null;
        
        const mapElement = document.getElementById("map");
        let width = mapElement.clientWidth || 900;
        let height = mapElement.clientHeight || 600;
        const maxJapanCopies = 3; // ç”»é¢ã«åŒæ™‚ã«æç”»ã™ã‚‹æœ€å¤§ã®æ—¥æœ¬åˆ—å³¶ã®æ•°
        
        const svg = d3.select("#map")
            .append("svg")
            .attr("width", "100%")
            .attr("height", "100%");
        
        const tooltip = d3.select("#tooltip");
        
        // GeoJSONãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
        d3.json("japan.geojson")
            .then(data => {
                geoData = data;
                updateMap();
            })
            .catch(error => {
                console.error("GeoJSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
                alert("åœ°å›³ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚japan.geojsonãƒ•ã‚¡ã‚¤ãƒ«ãŒåŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            });
        
        function updateMap() {
            if (!geoData) return;
            
            const yearIndex = parseInt(document.getElementById("yearSlider").value);
            currentYearIndex = yearIndex;
            const year = years[yearIndex];
            const gdp = gdpData[yearIndex];
            const gdpRatio = (gdp / currentGDP) * 100;
            const japanCount = gdp / currentGDP; // æ—¥æœ¬åˆ—å³¶ä½•å€‹åˆ†ã‹
            const areaRatio = gdpRatio; // å›½åœŸé¢ç©ã®å‰²åˆï¼ˆ%ï¼‰
            
            // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
            document.getElementById("yearDisplay").textContent = year;
            document.getElementById("currentGDP").textContent = formatGDP(gdp);
            document.getElementById("gdpRatio").textContent = gdpRatio.toFixed(1) + "%";
            document.getElementById("areaRatio").textContent = areaRatio.toFixed(1) + "%";
            document.getElementById("japanCount").textContent = japanCount.toFixed(2) + "å€‹";
            
            // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆç”»é¢å¹…ã„ã£ã±ã„ä½¿ã£ã¦æ—¥æœ¬åˆ—å³¶ã‚’æ¨ªã«ä¸¦ã¹ã‚‹ï¼‰
            width = mapElement.clientWidth || width;
            height = mapElement.clientHeight || 600;
            svg.attr("width", "100%").attr("height", height);
            
            const totalCopies = Math.max(1, Math.min(maxJapanCopies, Math.ceil(japanCount || 1)));
            const copyWidth = width / totalCopies;
            
            // åœ°å›³ã‚’æ›´æ–°
            svg.selectAll("*").remove();
            
            // éƒ½é“åºœçœŒåã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆGeoJSONã®æ—¥æœ¬èªåã‚’ä½¿ç”¨ï¼‰
            const prefectureMap = {};
            geoData.features.forEach(feature => {
                const jpName = feature.properties.NL_NAME_1 || prefectureNameMap[feature.properties.NAME_1];
                if (jpName) {
                    prefectureMap[feature.properties.NAME_1] = jpName;
                }
            });
            
            // å„æ—¥æœ¬åˆ—å³¶ã‚³ãƒ”ãƒ¼ã‚’æç”»ï¼ˆæ å†…ã«æ—¥æœ¬å…¨ä½“ãŒåã¾ã‚‹ã‚ˆã†ã«fitExtentã‚’ä½¿ç”¨ï¼‰
            for (let copyIndex = 0; copyIndex < totalCopies; copyIndex++) {
                // ã“ã®ã‚³ãƒ”ãƒ¼ã«å¯¾å¿œã™ã‚‹ã€Œä½•ï¼…ã¶ã‚“ã®æ—¥æœ¬ã‹ã€
                let copyRatio = 0;
                if (japanCount >= copyIndex + 1) {
                    copyRatio = 1; // ãƒ•ãƒ«ã«1æ—¥æœ¬åˆ†
                } else if (japanCount > copyIndex) {
                    copyRatio = japanCount - copyIndex; // 0ã€œ1ã®ç«¯æ•°ã¶ã‚“
                } else {
                    copyRatio = 0; // ã¾ã åˆ°é”ã—ã¦ã„ãªã„æ—¥æœ¬
                }
                
                // éƒ½é“åºœçœŒã‚’é¢ç©é †ã«ã‚½ãƒ¼ãƒˆ
                const sortedPrefectures = [...prefectureAreas].sort((a, b) => b.area - a.area);
                
                // é¢ç©ãŒè¿‘ã„éƒ½é“åºœçœŒã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼ˆé¢ç©å·®ãŒ30%ä»¥å†…ãªã‚‰åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰
                const groups = [];
                let currentGroup = [];
                let currentGroupAvgArea = null;
                
                for (const pref of sortedPrefectures) {
                    if (currentGroup.length === 0) {
                        currentGroup.push(pref);
                        currentGroupAvgArea = pref.area;
                    } else {
                        // ç¾åœ¨ã®ã‚°ãƒ«ãƒ¼ãƒ—ã®å¹³å‡é¢ç©ã¨ã®å·®ãŒ30%ä»¥å†…ãªã‚‰åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—
                        const areaDiff = Math.abs(pref.area - currentGroupAvgArea) / currentGroupAvgArea;
                        if (areaDiff <= 0.3) {
                            currentGroup.push(pref);
                            // ã‚°ãƒ«ãƒ¼ãƒ—ã®å¹³å‡é¢ç©ã‚’æ›´æ–°
                            currentGroupAvgArea = currentGroup.reduce((sum, p) => sum + p.area, 0) / currentGroup.length;
                        } else {
                            // æ–°ã—ã„ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹
                            groups.push([...currentGroup]);
                            currentGroup = [pref];
                            currentGroupAvgArea = pref.area;
                        }
                    }
                }
                if (currentGroup.length > 0) {
                    groups.push(currentGroup);
                }
                
                // å„ã‚°ãƒ«ãƒ¼ãƒ—ã®ç·é¢ç©ã‚’è¨ˆç®—
                const groupAreas = groups.map(group => ({
                    group: group,
                    totalArea: group.reduce((sum, p) => sum + p.area, 0)
                }));
                
                // GDPå‰²åˆã«å¿œã˜ã¦ã€ã‚°ãƒ«ãƒ¼ãƒ—å˜ä½ã§å¡—ã‚Šã¤ã¶ã™
                let cumulativeArea = 0;
                const targetArea = copyRatio * totalArea;
                const highlightedPrefectures = new Set();
                const partialPrefectures = new Map(); // éƒ¨åˆ†çš„ã«å¡—ã‚‹éƒ½é“åºœçœŒï¼ˆéƒ½é“åºœçœŒå -> å¡—ã‚‹å‰²åˆï¼‰
                
                for (const groupArea of groupAreas) {
                    const groupTotalArea = groupArea.totalArea;
                    
                    if (cumulativeArea + groupTotalArea <= targetArea) {
                        // ã‚°ãƒ«ãƒ¼ãƒ—å…¨ä½“ã‚’å¡—ã‚‹
                        groupArea.group.forEach(pref => {
                            highlightedPrefectures.add(pref.jpName);
                        });
                        cumulativeArea += groupTotalArea;
                    } else if (cumulativeArea < targetArea) {
                        // ã‚°ãƒ«ãƒ¼ãƒ—ã®ä¸€éƒ¨ã ã‘å¡—ã‚‹
                        const remainingArea = targetArea - cumulativeArea;
                        const groupRatio = remainingArea / groupTotalArea;
                        
                        // ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®éƒ½é“åºœçœŒã‚’å‡ç­‰ã«å¡—ã‚‹
                        groupArea.group.forEach(pref => {
                            const prefRatio = groupRatio;
                            if (prefRatio >= 1) {
                                highlightedPrefectures.add(pref.jpName);
                            } else if (prefRatio > 0) {
                                partialPrefectures.set(pref.jpName, prefRatio);
                            }
                        });
                        cumulativeArea = targetArea;
                        break;
                    } else {
                        break;
                    }
                }
                
                const projection = d3.geoMercator();
                const path = d3.geoPath().projection(projection);

                // ã“ã®ã‚³ãƒ”ãƒ¼ç”¨ã®æç”»ç¯„å›²ï¼ˆå·¦å³ã«åˆ†å‰²ã—ãŸæ ã®ä¸­ã«æ—¥æœ¬å…¨ä½“ãŒåã¾ã‚‹ã‚ˆã†ã«èª¿æ•´ï¼‰
                const left = copyIndex * copyWidth + 10;
                const right = (copyIndex + 1) * copyWidth - 10;
                const top = 10;
                const bottom = height - 10;

                projection.fitExtent(
                    [[left, top], [right, bottom]],
                    geoData
                );
                
                const group = svg.append("g").attr("class", "japan-copy");
                
                group.selectAll(".prefecture")
                    .data(geoData.features)
                    .enter()
                    .append("path")
                    .attr("class", "prefecture")
                    .attr("d", path)
                    .attr("fill", d => {
                        const jpName = d.properties.NL_NAME_1 || prefectureNameMap[d.properties.NAME_1];
                        if (highlightedPrefectures.has(jpName)) {
                            return "#4CAF50";
                        } else if (partialPrefectures.has(jpName)) {
                            // éƒ¨åˆ†çš„ã«å¡—ã‚‹å ´åˆã¯ã€å‰²åˆã«å¿œã˜ã¦è‰²ã‚’èª¿æ•´
                            const ratio = partialPrefectures.get(jpName);
                            // ç·‘ã¨ã‚°ãƒ¬ãƒ¼ã®ä¸­é–“è‰²ã‚’è¨ˆç®—
                            const r = Math.round(76 + (224 - 76) * (1 - ratio)); // 4CAF50ã®Ræˆåˆ†76ã€E0E0E0ã®Ræˆåˆ†224
                            const g = Math.round(175 + (224 - 175) * (1 - ratio)); // 4CAF50ã®Gæˆåˆ†175ã€E0E0E0ã®Gæˆåˆ†224
                            const b = Math.round(80 + (224 - 80) * (1 - ratio)); // 4CAF50ã®Bæˆåˆ†80ã€E0E0E0ã®Bæˆåˆ†224
                            return `rgb(${r}, ${g}, ${b})`;
                        } else {
                            return "#E0E0E0";
                        }
                    })
                    .attr("stroke", "#fff")
                    .attr("stroke-width", 0.5)
                    .on("mouseover", function(event, d) {
                        const jpName = d.properties.NL_NAME_1 || prefectureNameMap[d.properties.NAME_1];
                        const isHighlighted = highlightedPrefectures.has(jpName);
                        const partialRatio = partialPrefectures.get(jpName);
                        let statusText = "";
                        if (isHighlighted) {
                            statusText = "âœ“ è©²å½“å¹´ã®GDPã«ç›¸å½“";
                        } else if (partialRatio !== undefined) {
                            statusText = `â–³ è©²å½“å¹´ã®GDPã®${(partialRatio * 100).toFixed(1)}%ã«ç›¸å½“`;
                        } else {
                            statusText = "è©²å½“å¹´ã®GDPã«ç›¸å½“ã—ãªã„";
                        }
                        tooltip
                            .style("display", "block")
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 10) + "px")
                            .html(`<strong>${jpName}</strong><br/>${statusText}`);
                    })
                    .on("mouseout", function() {
                        tooltip.style("display", "none");
                    });
            }
        }
        
        function formatGDP(value) {
            if (value >= 1e12) {
                return "$" + (value / 1e12).toFixed(2) + "å…†";
            } else if (value >= 1e11) {
                return "$" + (value / 1e11).toFixed(2) + "åƒå„„";
            } else if (value >= 1e10) {
                return "$" + (value / 1e10).toFixed(2) + "ç™¾å„„";
            } else {
                return "$" + (value / 1e9).toFixed(2) + "åå„„";
            }
        }
        
        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆ
        document.getElementById("yearSlider").addEventListener("input", updateMap);
        
        // å†ç”Ÿãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
        document.getElementById("playBtn").addEventListener("click", function() {
            if (isPlaying) {
                clearInterval(playInterval);
                this.textContent = "â–¶ å†ç”Ÿ";
                isPlaying = false;
            } else {
                this.textContent = "â¸ åœæ­¢";
                isPlaying = true;
                playInterval = setInterval(() => {
                    let nextIndex = currentYearIndex - 1;
                    if (nextIndex < 0) {
                        nextIndex = 64;
                    }
                    document.getElementById("yearSlider").value = nextIndex;
                    updateMap();
                }, 500);
            }
        });
        
        // åˆæœŸè¡¨ç¤º
        updateMap();
    </script>
</body>
</html>

